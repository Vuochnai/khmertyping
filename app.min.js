/*! Khmer Typing - v0.1.0 - 2015-03-30
* http://sovichet.info/khmertyping/
* Copyright (c) 2015 Sovichet Tep; Licensed MIT */
angular.module("appModule",["coreModule","ui.bootstrap","lessons","keyboard","misc","ngCookies"]).controller("IntroCtrl",["$scope","$cookieStore",function(a,b){a.visited=b.get("visited")||!1,a.deleteCookie=function(){b.remove("visited")},a.dismiss=function(){b.put("visited",!0),a.visited=!0}}]).controller("TypingCtrl",["$scope","$timeout","TypingService","$modal","lessonList","$interval","compositeVowels","$detect","$keyboard",function(a,b,c,d,e,f,g,h,i){function j(){a.correct=a.correct+1,a.complete=100*a.correct/a.lessonLength,C++,C%95===0&&0!==C&&B<A.scrollTopMax&&(B+=36,A.scrollTop=B,C=3),p!=v||r!=s.length-1?(r<s.length-1?r++:(r=0,c.removeHighlight(p),p++,c.addHighlight(p),s=c.getWord(p)),i.setPos(s[r]),a.$apply(function(){switch(s[r]){case" ":a.toType="ដកឃ្លា";break;case"​":a.toType="ចន្លោះ​មិន​ឃើញ";break;case"\r":a.toType="ចុះ​បន្ទាត់";break;default:a.toType=s[r]}})):(a.stopTyping(),a.finishModal())}function k(b,c){o=c||s[r].charCodeAt(0),"\r"==s[r]?13==b.keyCode&&j():b.charCode==o?j():t===!0&&a.$apply(function(){a.wrong+=1})}function l(a){switch(a.preventDefault(),s[r]){case"ុះ":o=g[0];break;case"ុំ":o=g[1];break;case"េះ":o=g[2];break;case"ោះ":o=g[3];break;case"ាំ":o=g[4];break;default:o=void 0}k(a,o)}function m(b){switch(b.preventDefault(),console.log(b),s[r]){case"ុះ":case"ុំ":case"េះ":case"ោះ":case"ាំ":w=!0;break;default:w=!1}w?b.charCode===s[r].charCodeAt(x)?(x++,2===x&&(x=0,w=!1,j())):a.$apply(function(){a.wrong++}):k(b)}function n(){q+=1,a.wpm=Math.round(a.correct/5/(q/60))}a.correct=0,a.wrong=0,a.started=!1,a.isMacintosh=!1,a.wpm=0,a.toType="",a.title="",a.lessonInfo="",a.complete=100,a.lessonLength=0;var o=0,p=0,q=0,r=0,s="",t=null,u=null,v=0,w=!1,x=0,y=h.init(),z=document.getElementById("lesson-select"),A=document.getElementById("text"),B=0,C=0;z.disabled=!1,"Macintosh"===y.os.name&&(a.isMacintosh=!0),a.startTyping=function(){a.started||""===e.current?console.log("សូម​ជ្រើសរើស​មេរៀន"):(a.reset(),c.loadTextFromJSON(e.current).then(function(){var b=c.lesson();switch(t=b.error,s=c.getWord(0),c.addHighlight(0),A.scrollTop=0,v=c.getWordListLength()-1,a.started=!0,z.disabled=!0,a.title=b.title,a.complete=0,a.lessonLength=c.getAllLetter().length,a.toType=s[0],i.init(),i.setPos(s[0]),b.textbox===!0&&(a.textarea=b.text),b.info&&(a.lessonInfo=b.info),b.wpm===!0&&(u=f(n,1e3)),y.os.name){case"Linux":angular.element(document).bind("keypress",l);break;case"Windows":angular.element(document).bind("keypress",m)}}))},a.stopTyping=function(){a.started=!1,z.disabled=!1,null!==u&&(f.cancel(u),u=null),angular.element(document).unbind("keypress")},a.reset=function(){c.clear(),a.lessonInfo="",a.textarea="",a.toType="",a.wpm=0,A.scrollTop=0,t=null,C=0,B=0,q=0,r=0,p=0,s="",a.wrong=0,a.correct=0},a.finishModal=function(){d.open({templateUrl:"finished.html",size:"sm",backdrop:"static",scope:a,controller:["$scope","$modalInstance",function(a,b){a.gonext=function(){b.close("next")},a.closeModal=function(){b.dismiss("close")}}]}).result.then(function(b){"next"===b&&(e.gotoNext(),a.startTyping())})},a.openModal=function(a){d.open({templateUrl:a,windowClass:"infobox",controller:["$scope","$modalInstance",function(a,b){a.closeModal=function(){b.dismiss("close")}}]})}}]).controller("lessonList",["$scope","lessonList","$modal",function(a,b,c){b.init(),a.lessons=b.getItemList(),a.nextLesson=a.lessons[1].filename,a.lessonName="ជ្រើស​រើស​មេរៀន",a.$on("finished",function(b,c){a.lessonName=c}),a.openModal=function(d){c.open({templateUrl:"lessonModal.html",controller:"lessonModal",size:d,resolve:{lessons:function(){return a.lessons}}}).result.then(function(c){a.lessonName=c.name,b.current=c.filename,b.index=c.index})}}]).controller("lessonModal",["$scope","$modalInstance","lessons",function(a,b,c){a.selectedItem="",a.lessons=c,a.choose=function(a){b.close(a)},a.closeModal=function(){b.dismiss("close")}}]),angular.module("coreModule",[]).factory("TypingService",["$http",function(a){var b,c=[],d=[],e="",f=document.getElementById("text");f&&(b=f.children);var g={},h=function(){var a=0,b=[];d=[];for(var f=e.split(""),g="";a<f.length;)"ុ"==f[a]?(g=f[a],("ំ"==f[a+1]||"ះ"==f[a+1])&&(g+=f[a+1],a++)):"េ"==f[a]&&"ះ"==f[a+1]||"ោ"==f[a]&&"ះ"==f[a+1]||"ា"==f[a]&&"ំ"==f[a+1]?(g=f[a]+f[a+1],a++):g=f[a],d.push(g),a++;for(a=0,f=[];a<d.length;)"​"==d[a]||" "==d[a]?(c.push(b),c.push(new Array(d[a])),b=[]):(b.push(d[a]),a==d.length-1&&c.push(b)),a++},i=function(){var a=0,b=0,d="";if(0!==c.length)for(;a<c.length;){for(;b<c[a].length;)d+=c[a][b],b++;f.innerHTML+='<span class="w">'+d+"</span>",b=0,d="",a++}else f.innerHTML="No word in list."};return{lesson:function(){return g},addHighlight:function(a){try{b[a].classList.add("ac")}catch(c){console.log(c)}},removeHighlight:function(a){b[a].classList.remove("ac")},loadTextFromString:function(a){e=a,h()},loadTextFromJSON:function(b){return a({method:"GET",url:"lessons/"+b+".js",cache:!1}).success(function(a,b,c,d){g=a,e=g.text,h(),i()}).error(function(a,b,c,d){alert("There is something went wrong.\nError: "+b)})},clear:function(){f.innerHTML="",c=[]},getWord:function(a){return c[a]},getAllLetter:function(){return d},getWordListLength:function(){return b.length}}}]),angular.module("keyboard",[]).factory("$keyboard",function(){var a=angular.element(document.getElementById("kb-clip")).children()[0],b=a.x.baseVal,c=a.y.baseVal,d=angular.element(document.getElementById("kb-key"))[0].style,e=angular.element(document.getElementById("shift-key"))[0].style,f=angular.element(document.getElementById("space-key"))[0].style,g=angular.element(document.getElementById("altgr-key"))[0].style,h={"​":{x:182.038,y:183.731,shift:!1,altGr:!1}," ":{x:182.038,y:183.731,shift:!0,altGr:!1},"្":{x:361.95,y:91.509,shift:!1,altGr:!1},"១":{x:45.238,y:0,shift:!1,altGr:!1},"២":{x:90.483,y:0,shift:!1,altGr:!1},"៣":{x:135.727,y:0,shift:!1,altGr:!1},"៤":{x:180.972,y:0,shift:!1,altGr:!1},"៥":{x:226.216,y:0,shift:!1,altGr:!1},"៦":{x:271.461,y:0,shift:!1,altGr:!1},"៧":{x:316.705,y:0,shift:!1,altGr:!1},"៨":{x:361.95,y:0,shift:!1,altGr:!1},"៩":{x:407.194,y:0,shift:!1,altGr:!1},"០":{x:452.439,y:0,shift:!1,altGr:!1},"ក":{x:407.194,y:91.509,shift:!1,altGr:!1},"ខ":{x:158.35,y:137.42,shift:!1,altGr:!1},"គ":{x:407.194,y:91.509,shift:!0,altGr:!1},"ឃ":{x:158.35,y:137.42,shift:!0,altGr:!1},"ង":{x:271.461,y:91.61,shift:!1,altGr:!1},"ច":{x:203.594,y:137.42,shift:!1,altGr:!1},"ឆ":{x:67.861,y:45.8,shift:!1,altGr:!1},"ជ":{x:203.594,y:137.42,shift:!0,altGr:!1},"ឈ":{x:67.861,y:45.8,shift:!0,altGr:!1},"ញ":{x:361.95,y:91.509,shift:!0,altGr:!1},"ដ":{x:180.972,y:91.61,shift:!1,altGr:!1},"ឋ":{x:113.105,y:137.42,shift:!1,altGr:!1},"ឌ":{x:180.972,y:91.61,shift:!0,altGr:!1},"ឍ":{x:113.105,y:137.42,shift:!0,altGr:!1},"ណ":{x:339.328,y:137.42,shift:!0,altGr:!1},"ត":{x:248.839,y:45.8,shift:!1,altGr:!1},"ថ":{x:226.216,y:91.61,shift:!1,altGr:!1},"ទ":{x:248.839,y:45.8,shift:!0,altGr:!1},"ធ":{x:226.216,y:91.61,shift:!0,altGr:!1},"ន":{x:339.328,y:137.42,shift:!1,altGr:!1},"ប":{x:294.083,y:137.42,shift:!1,altGr:!1},"ផ":{x:475.061,y:45.8,shift:!1,altGr:!1},"ព":{x:294.083,y:137.42,shift:!0,altGr:!1},"ភ":{x:475.061,y:45.8,shift:!0,altGr:!1},"ម":{x:384.572,y:137.42,shift:!1,altGr:!1},"យ":{x:294.083,y:45.8,shift:!1,altGr:!1},"រ":{x:203.594,y:45.8,shift:!1,altGr:!1},"ល":{x:452.439,y:91.61,shift:!1,altGr:!1},"វ":{x:248.839,y:137.42,shift:!1,altGr:!1},"ស":{x:135.727,y:91.61,shift:!1,altGr:!1},"ហ":{x:316.705,y:91.61,shift:!1,altGr:!1},"ឡ":{x:452.439,y:91.61,shift:!0,altGr:!1},"អ":{x:271.461,y:91.61,shift:!0,altGr:!1},"ឥ":{x:497.683,y:0,shift:!1,altGr:!1},"ឦ":{x:384.572,y:45.8,shift:!1,altGr:!0},"ឧ":{x:565.55,y:45.8,shift:!0,altGr:!1},"ឨ":{x:248.839,y:45.8,shift:!1,altGr:!0},"ឩ":{x:520.306,y:45.8,shift:!1,altGr:!0},"ឪ":{x:565.55,y:45.8,shift:!1,altGr:!1},"ឫ":{x:203.594,y:45.8,shift:!1,altGr:!0},"ឬ":{x:203.594,y:45.8,shift:!0,altGr:!1},"ឭ":{x:588.172,y:0,shift:!0,altGr:!1},"ឮ":{x:588.172,y:0,shift:!1,altGr:!1},"ឯ":{x:158.35,y:45.8,shift:!1,altGr:!0},"ឰ":{x:475.061,y:45.8,shift:!1,altGr:!0},"ឱ":{x:429.817,y:45.8,shift:!1,altGr:!0},"ឲ":{x:542.928,y:0,shift:!1,altGr:!1},"ឳ":{x:565.55,y:45.8,shift:!1,altGr:!0},"ា":{x:90.483,y:91.61,shift:!1,altGr:!1},"ិ":{x:384.572,y:45.8,shift:!1,altGr:!1},"ី":{x:384.572,y:45.8,shift:!0,altGr:!1},"ឹ":{x:113.105,y:45.8,shift:!1,altGr:!1},"ឺ":{x:113.105,y:45.8,shift:!0,altGr:!1},"ុ":{x:339.328,y:45.8,shift:!1,altGr:!1},"ូ":{x:339.328,y:45.8,shift:!0,altGr:!1},"ួ":{x:294.083,y:45.8,shift:!0,altGr:!1},"ើ":{x:497.683,y:91.61,shift:!1,altGr:!1},"ឿ":{x:520.306,y:45.8,shift:!0,altGr:!1},"ៀ":{x:520.306,y:45.8,shift:!1,altGr:!1},"េ":{x:158.35,y:45.8,shift:!1,altGr:!1},"ែ":{x:158.35,y:45.8,shift:!0,altGr:!1},"ៃ":{x:135.727,y:91.61,shift:!0,altGr:!1},"ោ":{x:429.817,y:45.8,shift:!1,altGr:!1},"ៅ":{x:429.817,y:45.8,shift:!0,altGr:!1},"ុំ":{x:429.817,y:137.42,shift:!1,altGr:!1},"ំ":{x:384.572,y:137.42,shift:!0,altGr:!1},"ាំ":{x:90.483,y:91.61,shift:!0,altGr:!1},"ះ":{x:316.705,y:91.61,shift:!0,altGr:!1},"ុះ":{x:429.817,y:137.42,shift:!0,altGr:!1},"េះ":{x:248.839,y:137.42,shift:!0,altGr:!1},"ោះ":{x:497.683,y:91.61,shift:!0,altGr:!1},"ៗ":{x:90.483,y:0,shift:!0,altGr:!1},"៛":{x:180.972,y:0,shift:!0,altGr:!1},"៍":{x:271.461,y:0,shift:!0,altGr:!1},"័":{x:316.705,y:0,shift:!0,altGr:!1},"៏":{x:361.95,y:0,shift:!0,altGr:!1},"ៈ":{x:542.928,y:91.61,shift:!1,altGr:!0},"៉":{x:542.928,y:91.61,shift:!0,altGr:!1},"៊":{x:520.306,y:137.42,shift:!1,altGr:!1},"់":{x:542.928,y:91.61,shift:!1,altGr:!1},"៌":{x:497.683,y:0,shift:!0,altGr:!1},"៎":{x:542.928,y:0,shift:!1,altGr:!0},"។":{x:475.061,y:137.42,shift:!1,altGr:!1},"៕":{x:475.061,y:137.42,shift:!0,altGr:!1},"៖":{x:497.683,y:91.61,shift:!1,altGr:!0}};return{init:function(){d.display="block"},hide:function(){e.display="none",d.display="none"},setPos:function(a){void 0!==h[a]&&(b.value=h[a].x,c.value=h[a].y,e.display="none",f.display="none",g.display="none",h[a].shift===!0&&(e.display="block"),h[a].altGr===!0&&(g.display="block"),(" "===a||"​"===a)&&(f.display="block"))}}}),angular.module("lessons",[]).factory("lessonList",["$rootScope",function(a){var b=[["១.១ មូលដ្ឋាន​វាយ​អក្សរ","១.២ ហ្វឹកហាត់​ពាក្យ"],["២.១ គ្រាប់​ចុច​ថ្មី ៖ េ ិ","២.២ គ្រាប់​ចុច​ថ្មី ៖ ែ ី","២.៣ ហ្វឹកហាត់​ពាក្យ"],["៣.១ គ្រាប់​ចុច​ថ្មី ៖ រ ុ","៣.២ គ្រាប់​ចុច​ថ្មី ៖ ឬ ូ","៣.៣ ហ្វឹកហាត់​ពាក្យ"],["៤.១ គ្រាប់​ចុច​ថ្មី ៖ ង ហ","៤.២ គ្រាប់​ចុច​ថ្មី ៖ អ ះ","៤.៣ ហ្វឹកហាត់​ពាក្យ"],["៥.១ របៀប​ដាក់​ជើង និង វណ្ណយុត​បន្តក់ (់)","៥.២ ហ្វឹកហាត់​ពាក្យ"],["៦.១ គ្រាប់​ចុច​ថ្មី ៖ ច ុំ","៦.២ គ្រាប់​ចុច​ថ្មី ៖ ជ ុះ","៦.៣ ហ្វឹកហាត់​ពាក្យ"],["៧.១ គ្រាប់​ចុច​ថ្មី ៖ ម វ","៧.២ គ្រាប់​ចុច​ថ្មី ៖ ំ េះ","៧.៣ ហ្វឹកហាត់​ពាក្យ"],["៨.១ គ្រាប់​ចុច​ថ្មី ៖ យ ត","៨.២ គ្រាប់​ចុច​ថ្មី ៖ ួ ទ","៨.៣ ហ្វឹកហាត់​ពាក្យ"],["៩.១ គ្រាប់​ចុច​ថ្មី ៖ ាំ ៃ ឌ ធ ញ គ ឡ ោះ","៩.២ ហ្វឹកហាត់​ពាក្យ"],["១០.១ គ្រាប់​ចុច​ថ្មី ៖ ន ប","១០.២ គ្រាប់​ចុច​ថ្មី ៖ ណ ព","១០.៣ ហ្វឹកហាត់​ពាក្យ"],["១១.១ គ្រាប់​ចុច​ថ្មី ៖ ោ ឹ ៀ","១១.២ គ្រាប់​ចុច​ថ្មី ៖ ៅ ឺ ឿ","១១.៣ ហ្វឹកហាត់​ពាក្យ"],["១២.១ គ្រាប់​ចុច​ថ្មី ៖ ផ ឆ","១២.២ គ្រាប់​ចុច​ថ្មី ៖ ភ ឈ","១២.៣ ហ្វឹកហាត់​ពាក្យ"],["១៣.១ វណ្ណយុត្តិ ៖ ត្រីសព្ទ និង មូសិកទន្ដ","១៣.២ វណ្ណយុត្តិ ៖ ៍ ័ ៏ ៌"],["១៤.១ គ្រាប់​ចុច​ថ្មី ៖ ឋ ខ","១៤.២ គ្រាប់​ចុច​ថ្មី ៖ ឍ ឃ","១៤.៣ ហ្វឹកហាត់​ពាក្យ"],["១៥.១ ស្រៈ​ពេញ​តួ","១៥.៣ ហ្វឹកហាត់​ពាក្យ"],["១៦.១ ហ្វឹកហាត់​អត្ថបទ","១៦.២ ហ្វឹកហាត់​អត្ថបទ"]],c={};return c.item=[],{init:function(){var a,d,e="",f=0;for(a=0;16>a;a++)for(d=0;d<b[a].length;d++)e=(10>a+1?"0"+(a+1).toString():(a+1).toString())+"."+(d+1).toString(),c.item.push({index:f,title:b[a][d],name:"មេរៀន "+e,filename:"lesson"+e}),f++;this.index=0,this.current=""},index:0,current:"",gotoNext:function(){this.index++,this.current=c.item[this.index].filename,a.$broadcast("finished",c.item[this.index].name)},getItemList:function(){return c.item}}}]),angular.module("misc",[]).value("compositeVowels",[6139,6140,6141,6142,6143]).factory("$detect",function(){return{options:[],header:[navigator.platform,navigator.userAgent,navigator.appVersion,navigator.vendor,window.opera],dataos:[{name:"Windows Phone",value:"Windows Phone",version:"OS"},{name:"Windows",value:"Win",version:"NT"},{name:"iPhone",value:"iPhone",version:"OS"},{name:"iPad",value:"iPad",version:"OS"},{name:"Kindle",value:"Silk",version:"Silk"},{name:"Android",value:"Android",version:"Android"},{name:"PlayBook",value:"PlayBook",version:"OS"},{name:"BlackBerry",value:"BlackBerry",version:"/"},{name:"Macintosh",value:"Mac",version:"OS X"},{name:"Linux",value:"Linux",version:"rv"},{name:"Palm",value:"Palm",version:"PalmOS"}],databrowser:[{name:"Chrome",value:"Chrome",version:"Chrome"},{name:"Firefox",value:"Firefox",version:"Firefox"},{name:"Safari",value:"Safari",version:"Version"},{name:"Internet Explorer",value:"MSIE",version:"MSIE"},{name:"Opera",value:"Opera",version:"Opera"},{name:"BlackBerry",value:"CLDC",version:"CLDC"},{name:"Mozilla",value:"Mozilla",version:"Mozilla"}],init:function(){var a=this.header.join(" "),b=this.matchItem(a,this.dataos),c=this.matchItem(a,this.databrowser);return{os:b,browser:c}},matchItem:function(a,b){var c,d,e,f,g,h=0,i=0;for(h=0;h<b.length;h+=1)if(c=new RegExp(b[h].value,"i"),e=c.test(a)){if(d=new RegExp(b[h].version+"[- /:;]([\\d._]+)","i"),f=a.match(d),g="",f&&f[1]&&(f=f[1]),f)for(f=f.split(/[._]+/),i=0;i<f.length;i+=1)g+=0===i?f[i]+".":f[i];else g="0";return{name:b[h].name,version:parseFloat(g)}}return{name:"unknown",version:0}}}});